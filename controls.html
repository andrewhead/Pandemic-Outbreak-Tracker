<!DOCTYPE html>
<head>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.1/themes/smoothness/jquery-ui.css">
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    <script src="//code.jquery.com/ui/1.11.1/jquery-ui.js"></script>
    <script src="query.js"></script>
    <link rel="stylesheet" href="controls.css" />
    <script>

        /* Slider with logarithmic scale */
        $.widget("custom.logSlider", $.ui.slider, {
            options: {
                min: 0,
                mx: 10000,
                logPower: 2,
                callback: undefined
            },
            _create: function() {
                $.ui.slider.prototype._create.call(this);
                var self = this;
                if (self.options['callback'] !== undefined) {
                    var callback = self.options['callback'];
                    self._setOption("slide", function(event, ui) {
                        callback(event, Math.pow(ui.value, self.options['logPower']));
                    });
                }
            },
            _setOption: function( key, value ) {
                var valueUpdated = false;
                if (key === "mx") {
                    this._setOption("max", Math.ceil(Math.pow(value, 1 / this.options['logPower'])));
                    if (this.options['value'] > this.options['max']) {
                        this.options['value'] = this.options['max'];
                    }
                    valueUpdated = true;
                } else if (key === "vl") {
                    this._setOption("value", Math.ceil(Math.pow(value, 1 / this.options['logPower'])));
                    valueUpdated = true;
                } else {
                    this._super( key, value );
                };

                // Force calling of callback when value is updated from outside
                if (valueUpdated === true) {
                    var sliderValue = this.options['value'];
                    var scaledValue = Math.pow(sliderValue, this.options['logPower']);
                    this.options['callback'](event, scaledValue);
                }
            }
        })
        
        /* Updates a list of countries that satisfy the query criteria */
        function updateCountries() {
            countries = getRiskCountries(
                disease=$("#disease_select").val(),
                date="20141005",
                minLifeExpectancy=$("#min_life_exp").val(),
                maxLifeExpectancy=$("#max_life_exp").val(),
                minRoutesInto=$("#routes").val(),
                considerBorderRisk=($("#border").data("clicked")),
                minLocalCases=$("#local_cases").val(),
                borderingCases=$("#border_cases").val()
            );
            $("#countries").val(String(countries));
        };

        function getMaxRoutes(data) {
            var maxRoutes = 0;
            for (var country in data.flights) {
                if (data.flights.hasOwnProperty(country)) {
                    for (var adjCountry in data.flights[country]) {
                        if (data.flights[country].hasOwnProperty(adjCountry)) {
                            if (data.flights[country][adjCountry] > maxRoutes) {
                                maxRoutes = data.flights[country][adjCountry];
                            }
                        }
                    }
                }
            }
            return maxRoutes;
        };

        function getMaxCases(data, disease) {
            var maxCases = 0;
            var diseaseData = data.cases[disease];
            for (var date in diseaseData) {
                if (diseaseData.hasOwnProperty(date)) {
                    var dateData = diseaseData[date];
                    for (var country in dateData) {
                        if (dateData.hasOwnProperty(country)) {
                            if (dateData[country] > maxCases) {
                                console.log(maxCases);
                                maxCases = dateData[country];
                            }
                        }
                    }
                }
            }
            return maxCases;
        }

        function getLifeExpectancyRange(data) {
            var minExpectancy = 1000;
            var maxExpectancy = 0;
            var expectancies = data.lifeExpectancies;
            for (var country in expectancies) {
                if (expectancies.hasOwnProperty(country)) {
                    if (expectancies[country] < minExpectancy) {
                        minExpectancy = expectancies[country];
                    }
                    if (expectancies[country] > maxExpectancy) {
                        maxExpectancy = expectancies[country];
                    }
                }
            }
            return [minExpectancy, maxExpectancy];
        }

        function updateSliders(disease) {
            
            var data = getData();
    
            var maxCases = getMaxCases(data, disease);
            var maxRoutes = getMaxRoutes(data);
            var expectancyRange = getLifeExpectancyRange(data);

            // Set maximum and minimum slider values
            $("#routes_slider").logSlider("option", "mx", maxRoutes);
            $("#local_cases_slider").logSlider("option", "mx", maxCases);
            $("#border_cases_slider").logSlider("option", "mx", maxCases);
            $("#life_exp_slider").slider("option", "min", expectancyRange[0]);
            $("#life_exp_slider").slider("option", "max", expectancyRange[1]);

            // Initialize or reset values as needed
            if ($("#min_life_exp").val() === "" || $("#max_life_exp").val() === "") {
                $("#life_exp_slider").slider("option", "values", [expectancyRange[0], expectancyRange[1]]);
                $("#min_life_exp").val(expectancyRange[0]);
                $("#max_life_exp").val(expectancyRange[1]);
            }
        }

        $(function() {
            /* Initialize logarithmic sliders */
            $("#routes_slider").logSlider({
                callback: function(event, value) {
                    $("#routes").val(value);
                    updateCountries();
                },
            });
            $("#local_cases_slider").logSlider({
                callback: function(event, value) {
                    $("#local_cases").val(value);
                    updateCountries();
                },
            });
            $("#border_cases_slider").logSlider({
                callback: function(event, value) {
                    $("#border_cases").val(value);
                    updateCountries();
                },
            });

            /* Initialize additional controls */
            $("#life_exp_slider").slider({
                range: true,
                slide: function(event, ui) {
                    $("#min_life_exp").val(ui.values[0]);
                    $("#max_life_exp").val(ui.values[1]);
                    updateCountries();
                }
            });
            $("#border").button().click(function() {
                if ($(this).data("clicked") === undefined) {
                    $(this).data("clicked", true);
                } else {
                    $(this).data("clicked", !$(this).data("clicked"));
                }
                updateCountries();
            })
            $("#border_label").attr("unselectable", "on")
                .css("user-select", "none");

            /* Initialize disease selector. */
            var diseaseSelect = $("#disease_select").selectmenu({
                change: function(event, ui) {
                    updateSliders(ui.item.value);
                }
            });

            updateSliders(diseaseSelect.val());
            updateCountries();
        });
    </script>
</head>
<body>
    <div>

        <h2>Disease</h2>
        <select name="disease" id="disease_select">
            <option value="ebola">Ebola</option>
            <option value="flu">Influenza</option>
        </select>

        <h2>Proximity</h2>
        <input type="checkbox" id="border"><label id="border_label" for="border">Consider border</label>
        <div id="routes_slider" class="slider"></div>
        <p>
            <input type="text" id="routes" class="counter" readonly/>
            <label for="routes">flight routes from affected country</label>
        </p>

        <h2>Severity</h2>
        <div id="local_cases_slider" class="slider"></div>
        <p>
            <input type="text" id="local_cases" class="counter" readonly/>
            <label for="local_cases">cases or more in country</label>
        </p>
        <div id="border_cases_slider" class="slider"></div>
        <p>
            <input type="text" id="border_cases" class="counter" readonly/>
            <label for="border_cases">cases or more in bordering country</label>
        </p>

        <h2>Country Stability</h2>
        <div id="life_exp_slider" class="slider"></div>
        <p>
            <input type="text" id="min_life_exp" class="counter" readonly/>
            <label>&nbsp;to&nbsp;</label>
            <input type="text" id="max_life_exp" class="counter" readonly/>
            <label for="life_exp">years life expectancy</label>
        <p>
            <label for="countries">At-risk countries</label>
            <input type="text" id="countries" readonly/>
        </p>
    </div>
</body>
