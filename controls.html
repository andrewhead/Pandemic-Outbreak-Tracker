<!DOCTYPE html>
<head>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.11.1/themes/smoothness/jquery-ui.css">
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    <script src="//code.jquery.com/ui/1.11.1/jquery-ui.js"></script>
    <script src="query.js"></script>
    <link rel="stylesheet" href="controls.css" />
    <script>

        /* Slider with logarithmic scale */
        $.widget("custom.logSlider", $.ui.slider, {
            options: {
                min: 0,
                maximum: 10000,
                logPower: 2,
                callback: undefined
            },
            _create: function() {
                $.ui.slider.prototype._create.call(this);
                var self = this;
                if (self.options['callback'] !== undefined) {
                    var callback = self.options['callback'];
                    self._setOption("slide", function(event, ui) {
                        callback(event, Math.pow(ui.value, self.options['logPower']));
                    });
                }
            },
            _setOption: function( key, value ) {
                if (key === "maximum") {
                    this._setOption("max", Math.pow(value, 1 / this.options['logPower']));
                } else {
                    this._super( key, value );
                };
            }
        })
        
        /* Updates a list of countries that satisfy the query criteria */
        function updateCountries() {
            countries = getRiskCountries(
                disease="ebola",
                date="20141005",
                minLifeExpectancy=40,
                maxLifeExpectancy=82,
                minRoutesInto=$("#routes").val(),
                considerBorderRisk=false,
                minLocalCases=$("#local_cases").val(),
                borderingCases=10000
            );
            $("#countries").val(String(countries));
        };

        function getMaxRoutes(data) {
            var maxRoutes = 0;
            for (var country in data.flights) {
                if (data.flights.hasOwnProperty(country)) {
                    for (var adjCountry in data.flights[country]) {
                        if (data.flights[country].hasOwnProperty(adjCountry)) {
                            if (data.flights[country][adjCountry] > maxRoutes) {
                                maxRoutes = data.flights[country][adjCountry];
                            }
                        }
                    }
                }
            }
            return maxRoutes;
        };

        function getMaxCases(data, disease) {
            var maxCases = 0;
            var diseaseData = data.cases[disease];
            for (var date in diseaseData) {
                if (diseaseData.hasOwnProperty(date)) {
                    var dateData = diseaseData[date];
                    for (var country in dateData) {
                        if (dateData.hasOwnProperty(country)) {
                            if (dateData[country] > maxCases) {
                                maxCases = dateData[country];
                            }
                        }
                    }
                }
            }
            return maxCases;
        }

        function setSliderBounds(disease) {
            var data = getData();
            var maxCases = getMaxCases(data, disease);
            var maxRoutes = getMaxRoutes(data);
            $("#routes_slider").logSlider("option", "maximum", maxRoutes);
            $("#local_cases_slider").logSlider("option", "maximum", maxCases);
            $("#border_cases_slider").logSlider("option", "maximum", maxCases);
        }

        $(function() {
            /* Initializes logarithmic sliders */
            $("#routes_slider").logSlider({
                callback: function(event, value) {
                    $("#routes").val(value);
                },
            });
            $("#local_cases_slider").logSlider({
                callback: function(event, value) {
                    $("#local_cases").val(value);
                },
            });
            $("#border_cases_slider").logSlider({
                callback: function(event, value) {
                    $("#border_cases").val(value);
                },
            });

            /* Initialize disease selector. */
            var diseaseSelect = $("#disease_select").selectmenu({
                change: function(event, ui) {
                    console.log(ui.item.value);
                    setSliderBounds(ui.item.value);
                }
            });
            setSliderBounds(diseaseSelect.val());
        });
    </script>
</head>
<body>
    <div>
        <label for="disease">Disease</label>
        <select name="disease" id="disease_select">
            <option value="ebola">Ebola</option>
            <option value="flu">Influenza</option>
        </select>
        <div id="routes_slider" class="slider"></div>
        <p>
            <input type="text" id="routes" class="counter" readonly/>
            <label for="routes">flight routes from affected country.</label>
        </p>
        <div id="local_cases_slider" class="slider"></div>
        <p>
            <input type="text" id="local_cases" class="counter" readonly/>
            <label for="local_cases">cases or more in country.</label>
        </p>
        <div id="border_cases_slider" class="slider"></div>
        <p>
            <input type="text" id="border_cases" class="counter" readonly/>
            <label for="border_cases">cases or more in bordering country.</label>
        </p>
        <p>
            <label for="countries">At-risk countries</label>
            <input type="text" id="countries" readonly/>
        </p>
    </div>
</body>
