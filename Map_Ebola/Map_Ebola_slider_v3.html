<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
	<script src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script src="http://d3js.org/queue.v1.min.js"></script>
	<script src="query.js"></script>
	<script src="geojson.js"></script>
	<script src="latlng.js"></script>
	<link rel="stylesheet" href="//code.jquery.com/ui/1.11.1/themes/smoothness/jquery-ui.css">
	<script src="//code.jquery.com/jquery-1.10.2.js"></script>
	<script src="//code.jquery.com/ui/1.11.1/jquery-ui.js"></script>
  
<style>
.legend {
    padding: 0px 0px;
    font: 10px sans-serif;
    background: white;
    background: rgba(255,255,255,0.8);
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    border-radius: 5px;
}

.key path {
	display: none;
}
</style>
</head>

<body>

<div id="map" style="width: 960px; height: 500px"></div>

<script>

function makeMap(data_ebola, geo_json) {
 
    

    L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: 'Map data (c) <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
    }).addTo(map);

	//for (country in data_ebola) {
	//	marker = L.marker(latlng[country]);
	//	marker.bindPopup(country);
	//	map.addLayer(marker);
	//};
	
	var color = d3.scale.threshold()
              .domain([1, 1000, 2000, 3000])
              .range(['#F1EEF6', '#D4B9DA', '#C994C7', '#DF65B0', '#E7298A']);

	function matchKey(datapoint, key_variable){
		countryExists = key_variable[datapoint];
		if (! countryExists) {
			return 0.0;
		} else {
			return parseFloat(countryExists);
		}
    };
	
    function style_1(feature) {
		return {
			fillColor: color(matchKey(feature.id, data_ebola)),
			weight: 1,
			opacity: 0.2,
			color: 'black',
			fillOpacity: 0.7
		};
	};

    gJson_layer_1 = L.geoJson(geo_json, {style: style_1}).addTo(map);

	var legend = L.control({position: 'topright'});

    legend.onAdd = function (map) {var div = L.DomUtil.create('div', 'legend'); return div};
    legend.addTo(map);

    var x = d3.scale.linear()
    .domain([0, 4000])
    .range([0, 400]);

    var xAxis = d3.svg.axis()
        .scale(x)
        .orient("top")
        .tickSize(1)
        .tickValues(color.domain())

    var svg = d3.select(".legend.leaflet-control").append("svg")
        .attr("id", 'legend')
        .attr("width", 450)
        .attr("height", 40);

    var g = svg.append("g")
        .attr("class", "key")
        .attr("transform", "translate(25,16)");

    g.selectAll("rect")
        .data(color.range().map(function(d, i) {
			return {
				x0: i ? x(color.domain()[i - 1]) : x.range()[0],
				x1: i < color.domain().length ? x(color.domain()[i]) : x.range()[1],
				z: d
			};
        }))
		.enter().append("rect")
			.attr("height", 10)
			.attr("x", function(d) { return d.x0; })
			.attr("width", function(d) { return d.x1 - d.x0; })
			.style("fill", function(d) { return d.z; });

    g.call(xAxis).append("text")
        .attr("class", "caption")
        .attr("y", 21)
        .text('Ebola Outbreaks Situation (2014-10-05)');
};

function updateMap(data_ebola, geo_json) {
	var color = d3.scale.threshold()
              .domain([1, 1000, 2000, 3000])
              .range(['#F1EEF6', '#D4B9DA', '#C994C7', '#DF65B0', '#E7298A']);

	function matchKey(datapoint, key_variable){
		countryExists = key_variable[datapoint];
		if (! countryExists) {
			return 0.0;
		} else {
			return parseFloat(countryExists);
		}
    };
	
    function style_1(feature) {
		return {
			fillColor: color(matchKey(feature.id, data_ebola)),
			weight: 1,
			opacity: 0.2,
			color: 'black',
			fillOpacity: 0.7
		};
	};

    gJson_layer_1 = L.geoJson(geo_json, {style: style_1}).addTo(map);
};

var map = L.map('map').setView([30, -20], 2);

var geo_json = getGeojson();

var latlng = getLatlng();

var data = getData();

var date;

makeMap(data.cases.ebola['20140322'], geo_json);

$(function() {
	var select = $( "#timestamp" );
	var slider = $( "<div id='slider'></div>" ).insertAfter( select ).slider({
		min: 1,
		max: 81,
		range: "min",
		value: select[0].selectedIndex + 1,
		slide: function( event, ui ) {
			select[0].selectedIndex = ui.value - 1;
			date = select[0][select[0].selectedIndex].value;
			updateMap(data.cases.ebola[date], geo_json);
		}
	});
	$( "#timestamp" ).change(function() {
		slider.slider( "value", this.selectedIndex + 1 );
	});
	//console.log(select[ 0 ][select[ 0 ].selectedIndex].value);
});

</script>

<form id="ebola_timestamp">
	<label for="timestamp">Timestamp</label>
	<select name="timestamp" id="timestamp">
		<option value="20140322">3/22/2014</option>
		<option value="20140324">3/24/2014</option>
		<option value="20140325">3/25/2014</option>
		<option value="20140326">3/26/2014</option>
		<option value="20140327">3/27/2014</option>
		<option value="20140328">3/28/2014</option>
		<option value="20140329">3/29/2014</option>
		<option value="20140331">3/31/2014</option>
		<option value="20140401">4/1/2014</option>
		<option value="20140404">4/4/2014</option>
		<option value="20140407">4/7/2014</option>
		<option value="20140409">4/9/2014</option>
		<option value="20140411">4/11/2014</option>
		<option value="20140414">4/14/2014</option>
		<option value="20140415">4/15/2014</option>
		<option value="20140416">4/16/2014</option>
		<option value="20140417">4/17/2014</option>
		<option value="20140420">4/20/2014</option>
		<option value="20140421">4/21/2014</option>
		<option value="20140422">4/22/2014</option>
		<option value="20140423">4/23/2014</option>
		<option value="20140424">4/24/2014</option>
		<option value="20140426">4/26/2014</option>
		<option value="20140501">5/1/2014</option>
		<option value="20140503">5/3/2014</option>
		<option value="20140505">5/5/2014</option>
		<option value="20140507">5/7/2014</option>
		<option value="20140510">5/10/2014</option>
		<option value="20140512">5/12/2014</option>
		<option value="20140523">5/23/2014</option>
		<option value="20140527">5/27/2014</option>
		<option value="20140528">5/28/2014</option>
		<option value="20140601">6/1/2014</option>
		<option value="20140603">6/3/2014</option>
		<option value="20140605">6/5/2014</option>
		<option value="20140610">6/10/2014</option>
		<option value="20140616">6/16/2014</option>
		<option value="20140617">6/17/2014</option>
		<option value="20140618">6/18/2014</option>
		<option value="20140619">6/19/2014</option>
		<option value="20140620">6/20/2014</option>
		<option value="20140622">6/22/2014</option>
		<option value="20140630">6/30/2014</option>
		<option value="20140702">7/2/2014</option>
		<option value="20140706">7/6/2014</option>
		<option value="20140708">7/8/2014</option>
		<option value="20140712">7/12/2014</option>
		<option value="20140714">7/14/2014</option>
		<option value="20140717">7/17/2014</option>
		<option value="20140720">7/20/2014</option>
		<option value="20140723">7/23/2014</option>
		<option value="20140727">7/27/2014</option>
		<option value="20140730">7/30/2014</option>
		<option value="20140801">8/1/2014</option>
		<option value="20140804">8/4/2014</option>
		<option value="20140806">8/6/2014</option>
		<option value="20140809">8/9/2014</option>
		<option value="20140811">8/11/2014</option>
		<option value="20140813">8/13/2014</option>
		<option value="20140816">8/16/2014</option>
		<option value="20140818">8/18/2014</option>
		<option value="20140820">8/20/2014</option>
		<option value="20140826">8/26/2014</option>
		<option value="20140831">8/31/2014</option>
		<option value="20140905">9/5/2014</option>
		<option value="20140907">9/7/2014</option>
		<option value="20140909">9/9/2014</option>
		<option value="20140910">9/10/2014</option>
		<option value="20140913">9/13/2014</option>
		<option value="20140914">9/14/2014</option>
		<option value="20140917">9/17/2014</option>
		<option value="20140919">9/19/2014</option>
		<option value="20140920">9/20/2014</option>
		<option value="20140921">9/21/2014</option>
		<option value="20140923">9/23/2014</option>
		<option value="20140928">9/28/2014</option>
		<option value="20141001">10/1/2014</option>
		<option value="20141004">10/4/2014</option>
		<option value="20141005">10/5/2014</option>
		<option value="20141007">10/7/2014</option>
		<option value="20141008">10/8/2014</option>
	</select>
</form>

</body>
</html>